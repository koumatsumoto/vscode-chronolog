## ChronoLog 拡張機能 仕様書 (案)

### 1. 概要

- **名称:** VS Code ChronoLog
- **目的:** 独自形式「ChronoLog (`.clog`)」で記述された時系列メモを VS Code 上で効率的に扱い、その内容をタイムラインとグラフで可視化する拡張機能。
- **ターゲットユーザー:** 調査記録、研究ノート、プロジェクトログ、思考メモなどを時系列で管理したい VS Code ユーザー。
- **開発言語:** TypeScript

### 2. ファイル形式: ChronoLog (`.clog`)

- **拡張子:** `.clog`
- **基本構造:** UTF-8 エンコーディングのプレーンテキストファイル。
- **メモ区切り:** 1 つ以上の空行、または行頭の `---` (ハイフン 3 つ)。(どちらを採用するか、あるいは両方許容するか要検討)
- **メモ構造:** 各メモは以下の要素を含むことができる。
  - **メタデータ:** 行頭に `@` を付けたキーと値で表現。
    - `@topic: トピック名` (任意。省略時は直前のメモのトピックを継承、またはファイル単位で設定)
    - `@time: YYYY-MM-DD HH:mm:ss` (任意。省略時はファイル保存時やメモ追記時の時刻を自動挿入する機能も検討)
    - `@link: URLやファイルパス` (任意。複数行記述可能)
    - その他、必要に応じて独自のメタデータを定義可能 (例: `@tags: タグ1, タグ2`)
  - **内容:** メタデータ行以降の、次のメモ区切りまでのテキスト。複数行可能。
  - **グラフ構造定義:** メモ内容内に特別な記法で記述。
    - `[ノードA] -> [ノードB]` (単純な接続)
    - `[ノードC] -> [ノードD]: 関係性の説明` (ラベル付き接続)
    - ノード名は、そのメモ自体を指す識別子（例: `@id: memo1` のようにメモに ID を付与）や、メモ内の特定のテキスト（トピック名など）を参照できるようにするルールを定める。
- **コメント:** 行頭を `#` とすることで、その行をコメントとして扱う (プレビューでは無視される)。
- **ファイル例 (`example.clog`):**

```text
# ChronoLog 形式のサンプルファイル

@topic: プロジェクトX 初期調査
@time: 2025-04-20 10:00:00
@link: [https://example.com/spec/v1](https://example.com/spec/v1)
最初の要求仕様を確認。
いくつかの不明点あり。 @id: req-check

---

@topic: プロジェクトX 初期調査
@time: 2025-04-22 14:30:00
@tags: 質問, 確認待ち
不明点について担当者に質問メール送信。 @id: question-sent
回答待ち。

[req-check] -> [question-sent]: 不明点解消のため

---
@topic: 新機能アイデア
@time: 2025-04-25 09:15:00
現在のタイムライン表示に加えて、トピックごとのフィルタリング機能が必要かもしれない。
UIデザインを検討。
```

### 3. 機能要件

1.  **エディタ連携:**
    - `.clog` ファイルに対するシンタックスハイライト (メタデータ、グラフ定義、コメントなどを色分け)。
    - コマンドパレット (`Ctrl+Shift+P`) から `ChronoLog: Preview` コマンドを実行、またはエディタ右上のアイコンクリックでプレビューパネルを開閉。
    - (将来) `@time:` の自動挿入や、メモテンプレートのスニペット提供。
2.  **プレビュー機能 (Webview):**
    - 現在アクティブな `.clog` ファイルの内容を解析し、プレビュー表示。
    - ファイルの変更（保存時）を検知し、プレビューを自動更新。
    - **タイムライン表示:**
      - 垂直タイムライン形式（最新が上、古いものが下）。
      - 各メモをノード（円やカード）で表現。ノードには時刻、トピック名の一部などを表示。
      - ノードのホバー/クリックで、メモの全文、メタデータ（リンク含む）をポップアップや別パネルに表示。
      - 表示する時間範囲の調整機能（任意）。
    - **グラフ表示:**
      - ファイル内のグラフ構造定義 (`[A] -> [B]: label`) を解析。
      - ノードと、関係性を示すラベル付きのエッジ（線）を描画。
      - タイムライン上のノードとグラフ上のノードを連動させる（例: クリックでハイライト）。
      - グラフのレイアウトアルゴリズムを選択可能にする（任意）。
    - **インタラクション:**
      - プレビュー内の `@link:` をクリックしてブラウザや関連ファイルを開く。
      - (将来) プレビュー上のノードから、エディタの対応するメモ箇所へジャンプ。
      - (将来) メモ内容のキーワード検索機能。
      - (将来) トピック、タグ、期間によるメモのフィルタリング機能。
3.  **設定:**
    - (将来) プレビューの外観（色、ノードサイズ、タイムライン密度など）に関する設定項目。
    - (将来) 時刻の自動挿入フォーマットやデフォルトトピックなどの設定。

### 4. 技術仕様

- **開発言語:** TypeScript
- **プラットフォーム:** VS Code Extension API
- **プレビュー (Webview):**
  - HTML / CSS / TypeScript (JavaScript)
  - **UI フレームワーク (推奨):** React, Vue, Svelte など
  - **グラフ可視化ライブラリ (必須):** `vis-network`, `Mermaid`, `D3.js` などを検討。メモ間の関連性描画に使用。
  - **タイムライン UI:** 自作、または `vis-timeline` (vis-network と同じシリーズ) や他のライブラリを活用。
- **ChronoLog パーサー:**
  - 正規表現や文字列処理によるカスタムパーサーを実装。
- **状態管理:**
  - Extension Host (Node.js) と Webview (Browser) 間でのデータ通信には VS Code API の `Webview.postMessage()` と `window.addEventListener('message')` を使用。

### 5. 開発ステップ (案)

1.  **環境構築:** `yo code` で TypeScript 用の拡張機能プロジェクトを作成。
2.  **パーサー実装:** `.clog` 形式を解析し、メモオブジェクト配列とグラフ情報を生成するコアロジックを実装。
3.  **基本 Webview 表示:** Webview を開き、解析したメモデータをリスト表示。
4.  **タイムライン UI 実装:** 垂直タイムライン、ノード表現、ホバー/クリックでの詳細表示を実装。
5.  **グラフ描画実装:** グラフライブラリ導入、グラフ構造データの描画。
6.  **エディタ連携:** シンタックスハイライト定義、プレビュー表示コマンド実装。
7.  **ファイル変更検知:** ファイル保存時のプレビュー自動更新機能。
8.  **インタラクション強化:** リンククリック、相互ジャンプ機能など。
9.  **追加機能:** フィルタリング、検索、設定画面など (優先度に応じて)。
10. **テストとリファクタリング:** 品質向上。
11. **ドキュメント作成 &amp; 公開:** README、使い方ガイド作成、Marketplace への公開準備。
